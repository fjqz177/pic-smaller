var ht=Object.defineProperty;var lt=(m,w,v)=>w in m?ht(m,w,{enumerable:!0,configurable:!0,writable:!0,value:v}):m[w]=v;var F=(m,w,v)=>(lt(m,typeof w!="symbol"?w+"":w,v),v);(function(){"use strict";class m{constructor(t=1){F(this,"list",[]);F(this,"isRunning",!1);this.max=t}push(t){this.list.push(t),this.isRunning||this.do()}async do(){if(this.list.length===0){this.isRunning=!1;return}this.isRunning=!0;const t=[];for(let i=0;i<this.max;i++){const r=this.list.shift();r&&t.push(r)}const e=t.map(i=>i());await Promise.all(e),await this.do()}}class w{constructor(t,e){this.info=t,this.option=e}getOutputDimension(){const{method:t,width:e,height:i,short:r,long:o,cropWidthRatio:s,cropHeightRatio:a,cropWidthSize:_,cropHeightSize:T}=this.option.resize,I={x:0,y:0,width:this.info.width,height:this.info.height};if(t==="fitWidth"){if(!e)return I;const h=e/this.info.width*this.info.height;return{x:0,y:0,width:Math.ceil(e),height:Math.ceil(h)}}if(t==="fitHeight"){if(!i)return I;const h=i/this.info.height*this.info.width;return{x:0,y:0,width:Math.ceil(h),height:Math.ceil(i)}}if(t==="setShort"){if(!r)return I;let l,h;return this.info.width<=this.info.height?(l=r,h=l/this.info.width*this.info.height):(h=r,l=h/this.info.height*this.info.width),{x:0,y:0,width:Math.ceil(l),height:Math.ceil(h)}}if(t==="setLong"){if(!o)return I;let l,h;return this.info.width>=this.info.height?(l=o,h=l/this.info.width*this.info.height):(h=o,l=h/this.info.height*this.info.width),{x:0,y:0,width:Math.ceil(l),height:Math.ceil(h)}}if(t==="setCropRatio"){if(!s||!a)return I;let l=0,h=0,b=0,R=0;return s/a>=this.info.width/this.info.height?(l=0,b=this.info.width,R=this.info.width*a/s,h=(this.info.height-R)/2):(h=0,R=this.info.height,b=this.info.height*s/a,l=(this.info.width-b)/2),{x:Math.ceil(l),y:Math.ceil(h),width:Math.ceil(b),height:Math.ceil(R)}}if(t==="setCropSize"){if(!_||!T)return I;let l=_,h=T;_>=this.info.width&&(l=this.info.width),T>=this.info.height&&(h=this.info.height);const b=(this.info.width-l)/2,R=(this.info.height-h)/2;return{x:Math.ceil(b),y:Math.ceil(R),width:Math.ceil(l),height:Math.ceil(h)}}return I}failResult(){return{width:this.info.width,height:this.info.height,blob:this.info.blob,src:URL.createObjectURL(this.info.blob)}}getPreviewDimension(){const t=this.option.preview.maxSize;if(Math.max(this.info.width,this.info.height)<=t)return{x:0,y:0,width:this.info.width,height:this.info.height};let e,i;if(this.info.width>=this.info.height){const r=t/this.info.width;e=t,i=r*this.info.height}else e=t/this.info.height*this.info.width,i=t;return{x:0,y:0,width:Math.ceil(e),height:Math.ceil(i)}}async preview(){const{width:t,height:e,x:i,y:r}=this.getPreviewDimension(),o=await this.createBlob(t,e,i,r);return{width:t,height:e,blob:o,src:URL.createObjectURL(o)}}async createCanvas(t,e,i=0,r=0){const o=new OffscreenCanvas(t,e),s=o.getContext("2d"),a=await createImageBitmap(this.info.blob),_=this.option.resize.method;return _&&["setCropRatio","setCropSize"].includes(_)?s==null||s.drawImage(a,i,r,t,e,0,0,t,e):s==null||s.drawImage(a,0,0,this.info.width,this.info.height,0,0,t,e),a.close(),{canvas:o,context:s}}async createBlob(t,e,i=.6,r=0,o=0){const{canvas:s}=await this.createCanvas(t,e,r,o),a={type:this.info.blob.type,quality:i};return s.convertToBlob(a)}}class v extends w{async compress(){const t=this.getOutputDimension(),e=await this.createBlob(t.width,t.height,this.option.jpeg.quality,t.x,t.y);return{...t,blob:e,src:URL.createObjectURL(e)}}}function V(n,t,e,i){const r=u.compress_avif_js(f(n),t,e,f(i));return U(r)}function G(n,t,e,i){const r=u.compress_png_js(f(n),t,e,f(i));return U(r)}function J(){return{__proto__:null,"./pic_compress_wasm_bg.js":{__proto__:null,__wbg_Error_4577686b3a6d9b3a:function(t,e){const i=Error(C(t,e));return f(i)},__wbg_Number_e89e48a2fe1a6355:function(t){return Number(c(t))},__wbg_String_8564e559799eccda:function(t,e){const i=String(c(e)),r=L(i,u.__wbindgen_export,u.__wbindgen_export2),o=M;g().setInt32(t+4,o,!0),g().setInt32(t+0,r,!0)},__wbg___wbindgen_boolean_get_18c4ed9422296fff:function(t){const e=c(t),i=typeof e=="boolean"?e:void 0;return y(i)?16777215:i?1:0},__wbg___wbindgen_debug_string_ddde1867f49c2442:function(t,e){const i=D(c(e)),r=L(i,u.__wbindgen_export,u.__wbindgen_export2),o=M;g().setInt32(t+4,o,!0),g().setInt32(t+0,r,!0)},__wbg___wbindgen_in_1064a108f4d18b9e:function(t,e){return c(t)in c(e)},__wbg___wbindgen_is_function_d633e708baf0d146:function(t){return typeof c(t)=="function"},__wbg___wbindgen_is_null_a2a19127c13e7126:function(t){return c(t)===null},__wbg___wbindgen_is_object_4b3de556756ee8a8:function(t){const e=c(t);return typeof e=="object"&&e!==null},__wbg___wbindgen_is_undefined_c18285b9fc34cb7d:function(t){return c(t)===void 0},__wbg___wbindgen_jsval_loose_eq_1562ceb9af84e990:function(t,e){return c(t)==c(e)},__wbg___wbindgen_number_get_5854912275df1894:function(t,e){const i=c(e),r=typeof i=="number"?i:void 0;g().setFloat64(t+8,y(r)?0:r,!0),g().setInt32(t+0,!y(r),!0)},__wbg___wbindgen_string_get_3e5751597f39a112:function(t,e){const i=c(e),r=typeof i=="string"?i:void 0;var o=y(r)?0:L(r,u.__wbindgen_export,u.__wbindgen_export2),s=M;g().setInt32(t+4,s,!0),g().setInt32(t+0,o,!0)},__wbg___wbindgen_throw_39bc967c0e5a9b58:function(t,e){throw new Error(C(t,e))},__wbg__wbg_cb_unref_b6d832240a919168:function(t){c(t)._wbg_cb_unref()},__wbg_call_08ad0d89caa7cb79:function(){return K(function(t,e,i){const r=c(t).call(c(e),c(i));return f(r)},arguments)},__wbg_error_a6fa202b58aa1cd3:function(t,e){let i,r;try{i=t,r=e,console.error(C(t,e))}finally{u.__wbindgen_export4(i,r,1)}},__wbg_get_with_ref_key_6412cf3094599694:function(t,e){const i=c(t)[c(e)];return f(i)},__wbg_instanceof_ArrayBuffer_15859862b80b732d:function(t){let e;try{e=c(t)instanceof ArrayBuffer}catch{e=!1}return e},__wbg_instanceof_Uint8Array_2240b7046ac16f05:function(t){let e;try{e=c(t)instanceof Uint8Array}catch{e=!1}return e},__wbg_isSafeInteger_10e4151eb694e42a:function(t){return Number.isSafeInteger(c(t))},__wbg_length_5855c1f289dfffc1:function(t){return c(t).length},__wbg_new_09959f7b4c92c246:function(t){const e=new Uint8Array(c(t));return f(e)},__wbg_new_227d7c05414eb861:function(){const t=new Error;return f(t)},__wbg_new_from_slice_d7e202fdbee3c396:function(t,e){const i=new Uint8Array(q(t,e));return f(i)},__wbg_new_typed_8258a0d8488ef2a2:function(t,e){try{var i={a:t,b:e},r=(s,a)=>{const _=i.a;i.a=0;try{return X(_,i.b,s,a)}finally{i.a=_}};const o=new Promise(r);return f(o)}finally{i.a=i.b=0}},__wbg_prototypesetcall_f034d444741426c3:function(t,e,i){Uint8Array.prototype.set.call(q(t,e),c(i))},__wbg_queueMicrotask_2c8dfd1056f24fdc:function(t){const e=c(t).queueMicrotask;return f(e)},__wbg_queueMicrotask_8985ad63815852e7:function(t){queueMicrotask(c(t))},__wbg_resolve_5d61e0d10c14730a:function(t){const e=Promise.resolve(c(t));return f(e)},__wbg_stack_3b0d974bbf31e44f:function(t,e){const i=c(e).stack,r=L(i,u.__wbindgen_export,u.__wbindgen_export2),o=M;g().setInt32(t+4,o,!0),g().setInt32(t+0,r,!0)},__wbg_static_accessor_GLOBAL_THIS_14325d8cca34bb77:function(){const t=typeof globalThis>"u"?null:globalThis;return y(t)?0:f(t)},__wbg_static_accessor_GLOBAL_f3a1e69f9c5a7e8e:function(){const t=typeof global>"u"?null:global;return y(t)?0:f(t)},__wbg_static_accessor_SELF_50cdb5b517789aca:function(){const t=typeof self>"u"?null:self;return y(t)?0:f(t)},__wbg_static_accessor_WINDOW_d6c4126e4c244380:function(){const t=typeof window>"u"?null:window;return y(t)?0:f(t)},__wbg_then_f1c954fe00733701:function(t,e){const i=c(t).then(c(e));return f(i)},__wbindgen_cast_0000000000000001:function(t,e){const i=Z(t,e,u.__wasm_bindgen_func_elem_132,Q);return f(i)},__wbindgen_cast_0000000000000002:function(t,e){const i=C(t,e);return f(i)},__wbindgen_object_clone_ref:function(t){const e=c(t);return f(e)},__wbindgen_object_drop_ref:function(t){U(t)}}}}function Q(n,t,e){try{const o=u.__wbindgen_add_to_stack_pointer(-16);u.__wasm_bindgen_func_elem_133(o,n,t,f(e));var i=g().getInt32(o+4*0,!0),r=g().getInt32(o+4*1,!0);if(r)throw U(i)}finally{u.__wbindgen_add_to_stack_pointer(16)}}function X(n,t,e,i){u.__wasm_bindgen_func_elem_1126(n,t,f(e),f(i))}function f(n){O===d.length&&d.push(d.length+1);const t=O;return O=d[t],d[t]=n,t}const E=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>n.dtor(n.a,n.b));function D(n){const t=typeof n;if(t=="number"||t=="boolean"||n==null)return`${n}`;if(t=="string")return`"${n}"`;if(t=="symbol"){const r=n.description;return r==null?"Symbol":`Symbol(${r})`}if(t=="function"){const r=n.name;return typeof r=="string"&&r.length>0?`Function(${r})`:"Function"}if(Array.isArray(n)){const r=n.length;let o="[";r>0&&(o+=D(n[0]));for(let s=1;s<r;s++)o+=", "+D(n[s]);return o+="]",o}const e=/\[object ([^\]]+)\]/.exec(toString.call(n));let i;if(e&&e.length>1)i=e[1];else return toString.call(n);if(i=="Object")try{return"Object("+JSON.stringify(n)+")"}catch{return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:i}function Y(n){n<1028||(d[n]=O,O=n)}function q(n,t){return n=n>>>0,j().subarray(n/1,n/1+t)}let x=null;function g(){return(x===null||x.buffer.detached===!0||x.buffer.detached===void 0&&x.buffer!==u.memory.buffer)&&(x=new DataView(u.memory.buffer)),x}function C(n,t){return n=n>>>0,et(n,t)}let A=null;function j(){return(A===null||A.byteLength===0)&&(A=new Uint8Array(u.memory.buffer)),A}function c(n){return d[n]}function K(n,t){try{return n.apply(this,t)}catch(e){u.__wbindgen_export3(f(e))}}let d=new Array(1024).fill(void 0);d.push(void 0,null,!0,!1);let O=d.length;function y(n){return n==null}function Z(n,t,e,i){const r={a:n,b:t,cnt:1,dtor:e},o=(...s)=>{r.cnt++;const a=r.a;r.a=0;try{return i(a,r.b,...s)}finally{r.a=a,o._wbg_cb_unref()}};return o._wbg_cb_unref=()=>{--r.cnt===0&&(r.dtor(r.a,r.b),r.a=0,E.unregister(r))},E.register(o,r,r),o}function L(n,t,e){if(e===void 0){const a=S.encode(n),_=t(a.length,1)>>>0;return j().subarray(_,_+a.length).set(a),M=a.length,_}let i=n.length,r=t(i,1)>>>0;const o=j();let s=0;for(;s<i;s++){const a=n.charCodeAt(s);if(a>127)break;o[r+s]=a}if(s!==i){s!==0&&(n=n.slice(s)),r=e(r,i,i=s+n.length*3,1)>>>0;const a=j().subarray(r+s,r+i),_=S.encodeInto(n,a);s+=_.written,r=e(r,i,s,1)>>>0}return M=s,r}function U(n){const t=c(n);return Y(n),t}let W=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});W.decode();const tt=2146435072;let k=0;function et(n,t){return k+=t,k>=tt&&(W=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),W.decode(),k=t),W.decode(j().subarray(n,n+t))}const S=new TextEncoder;"encodeInto"in S||(S.encodeInto=function(n,t){const e=S.encode(n);return t.set(e),{read:n.length,written:e.length}});let M=0,u;function nt(n,t){return u=n.exports,x=null,A=null,u.__wbindgen_start(),u}async function it(n,t){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,t)}catch(r){if(n.ok&&e(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const i=await n.arrayBuffer();return await WebAssembly.instantiate(i,t)}else{const i=await WebAssembly.instantiate(n,t);return i instanceof WebAssembly.Instance?{instance:i,module:n}:i}function e(i){switch(i){case"basic":case"cors":case"default":return!0}return!1}}async function rt(n){if(u!==void 0)return u;n!==void 0&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),n===void 0&&(n=new URL("/pic-smaller/wasm/pic_compress_wasm_bg.wasm",self.location.href));const t=J();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:e,module:i}=await it(await n,t);return nt(e)}let z=!1,B=null;async function P(){z||(B||(B=(async()=>{const n=new URL("/pic-smaller/wasm/pic_compress_wasm_bg.wasm",self.location.href).href;await rt(n),z=!0,console.log("[PicCompressWasm] âœ… WASM module initialized")})()),await B)}async function ot(n,t,e,i={}){await P();const r={colors:i.colors??255,dithering:i.dithering??0,compression_level:i.compression_level??6};try{return await G(n,t,e,r)}catch(o){throw console.error("[PicCompressWasm] PNG compression failed:",o),o}}async function H(n,t,e,i={}){await P();const r={quality:i.quality??50,speed:i.speed??8};try{return await V(n,t,e,r)}catch(o){throw console.error("[PicCompressWasm] AVIF compression failed:",o),o}}class st extends w{async compress(){const{width:t,height:e,x:i,y:r}=this.getOutputDimension(),{context:o}=await this.createCanvas(t,e,i,r),s=o.getImageData(0,0,t,e).data;try{const a=await ot(new Uint8Array(s),t,e,{colors:this.option.png.colors,dithering:this.option.png.dithering,compression_level:6}),_=new Blob([a],{type:this.info.blob.type});return{width:t,height:e,blob:_,src:URL.createObjectURL(_)}}catch(a){return console.error("[PngImage] Compression failed:",a),this.failResult()}}}const p={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"};class ct extends w{static async encode(t,e,i,r=50,o=8){const s=t.getImageData(0,0,e,i).data,a=await H(new Uint8Array(s),e,i,{quality:r,speed:o});return new Blob([a],{type:p.avif})}async compress(){const{width:t,height:e,x:i,y:r}=this.getOutputDimension();try{const{context:o}=await this.createCanvas(t,e,i,r),s=o.getImageData(0,0,t,e).data,a=await H(new Uint8Array(s),t,e,{quality:this.option.avif.quality,speed:this.option.avif.speed}),_=new Blob([a],{type:p.avif});return{width:t,height:e,blob:_,src:URL.createObjectURL(_)}}catch(o){return console.error("[AvifImage] Compression failed:",o),this.failResult()}}}async function at(n,t="compress"){const e=await createImageBitmap(n.info.blob);if(n.info.width=e.width,n.info.height=e.height,t==="compress"&&n.option.format.target&&n.option.format.target!==n.info.blob.type){const i=n.option.format.target.toLowerCase();if(i==="avif")return N(n,t,p.avif);const r=new OffscreenCanvas(e.width,e.height),o=r.getContext("2d");["jpg","jpeg"].includes(i)&&(o.fillStyle=n.option.format.transparentFill,o.fillRect(0,0,e.width,e.height)),o.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),n.info.blob=await r.convertToBlob({type:p[i],quality:1})}return e.close(),N(n,t)}async function N(n,t,e){let i=n.info.blob.type.toLowerCase();e&&(i=e);let r=null;if([p.jpg,p.webp].includes(i)?r=new v(n.info,n.option):i===p.avif?r=new ct(n.info,n.option):i===p.png&&(r=new st(n.info,n.option)),!r)return null;const o={key:r.info.key,width:r.info.width,height:r.info.height};return r&&t==="preview"?(o.preview=await r.preview(),o):r&&t==="compress"?(o.compress=await r.compress(),o):null}const $="image/avif";async function ft(){const n=new OffscreenCanvas(1,1);n.getContext("2d");try{return await n.convertToBlob({type:$}),!0}catch{return!1}}async function ut(){await ft()&&(p.avif=$)}function _t(n){return async()=>{await ut();const t=new m(3);globalThis.addEventListener("message",async e=>{t.push(async()=>{const i=await at(e.data,n);i&&globalThis.postMessage(i)})})}}_t("compress")()})();
