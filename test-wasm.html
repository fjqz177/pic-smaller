<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM æ¨¡å—æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .loading {
        background: #fff3cd;
        color: #856404;
      }
      button {
        padding: 10px 20px;
        margin: 10px 5px;
        cursor: pointer;
        font-size: 16px;
      }
      #log {
        background: #f5f5f5;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 3px;
      }
      .log-info {
        color: #333;
      }
      .log-success {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª WASM æ¨¡å—æµ‹è¯•</h1>

    <div id="init-status" class="status loading">â³ æ­£åœ¨åˆå§‹åŒ– WASM...</div>

    <div>
      <h2>æµ‹è¯•æ“ä½œ</h2>
      <button onclick="testPngCompression()">æµ‹è¯• PNG å‹ç¼©</button>
      <button onclick="testAvifCompression()">æµ‹è¯• AVIF å‹ç¼©</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div id="log">
      <div class="log-entry log-info">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script type="module">
      import {
        ensureWasmInit,
        compressPng,
        compressAvif,
        isWasmInitialized,
      } from "./src/engines/PicCompressWasm.ts";

      // åˆå§‹åŒ– WASM
      async function initWasm() {
        const statusEl = document.getElementById("init-status");
        try {
          await ensureWasmInit();
          statusEl.textContent = "âœ… WASM æ¨¡å—å·²åˆå§‹åŒ–";
          statusEl.className = "status success";
          log("âœ… WASM åˆå§‹åŒ–æˆåŠŸï¼", "success");

          // æ£€æŸ¥æ˜¯å¦åœ¨ window ä¸Šæš´éœ²äº†æµ‹è¯•å‡½æ•°
          window.testPngCompression = testPngCompression;
          window.testAvifCompression = testAvifCompression;
          window.clearLog = clearLog;
        } catch (error) {
          statusEl.textContent = "âŒ WASM åˆå§‹åŒ–å¤±è´¥";
          statusEl.className = "status error";
          log("âŒ WASM åˆå§‹åŒ–å¤±è´¥ï¼š" + error.message, "error");
          console.error("WASM init error:", error);
        }
      }

      // æµ‹è¯• PNG å‹ç¼©
      async function testPngCompression() {
        log("ğŸ” å¼€å§‹æµ‹è¯• PNG å‹ç¼©...");
        try {
          // åˆ›å»ºæµ‹è¯•å›¾ç‰‡ (100x100 çº¢è‰²)
          const width = 100;
          const height = 100;
          const imageData = new Uint8Array(width * height * 4);
          for (let i = 0; i < width * height; i++) {
            imageData[i * 4] = 255; // R
            imageData[i * 4 + 1] = 0; // G
            imageData[i * 4 + 2] = 0; // B
            imageData[i * 4 + 3] = 255; // A
          }

          const start = performance.now();
          const result = await compressPng(imageData, width, height, {
            colors: 255,
            dithering: 0,
            compression_level: 6,
          });
          const duration = performance.now() - start;

          log(`âœ… PNG å‹ç¼©æˆåŠŸï¼`, "success");
          log(`   è€—æ—¶ï¼š${duration.toFixed(2)}ms`);
          log(`   åŸå§‹å¤§å°ï¼š${imageData.length} bytes`);
          log(`   å‹ç¼©åï¼š${result.length} bytes`);
          log(
            `   å‹ç¼©ç‡ï¼š${((1 - result.length / imageData.length) * 100).toFixed(2)}%`,
          );

          // åˆ›å»ºé¢„è§ˆ
          const blob = new Blob([result], { type: "image/png" });
          const url = URL.createObjectURL(blob);
          log(
            `   é¢„è§ˆï¼š<a href="${url}" target="_blank">ç‚¹å‡»æŸ¥çœ‹å‹ç¼©åçš„å›¾ç‰‡</a>`,
          );

          return result;
        } catch (error) {
          log(`âŒ PNG å‹ç¼©å¤±è´¥ï¼š${error.message}`, "error");
          console.error("PNG compression error:", error);
          throw error;
        }
      }

      // æµ‹è¯• AVIF å‹ç¼©
      async function testAvifCompression() {
        log("ğŸ” å¼€å§‹æµ‹è¯• AVIF å‹ç¼©...");
        try {
          const width = 100;
          const height = 100;
          const imageData = new Uint8Array(width * height * 4);
          for (let i = 0; i < width * height; i++) {
            imageData[i * 4] = 0; // R
            imageData[i * 4 + 1] = 255; // G
            imageData[i * 4 + 2] = 0; // B
            imageData[i * 4 + 3] = 255; // A
          }

          const start = performance.now();
          const result = await compressAvif(imageData, width, height, {
            quality: 50,
            speed: 8,
          });
          const duration = performance.now() - start;

          log(`âœ… AVIF å‹ç¼©æˆåŠŸï¼`, "success");
          log(`   è€—æ—¶ï¼š${duration.toFixed(2)}ms`);
          log(`   åŸå§‹å¤§å°ï¼š${imageData.length} bytes`);
          log(`   å‹ç¼©åï¼š${result.length} bytes`);
          log(
            `   å‹ç¼©ç‡ï¼š${((1 - result.length / imageData.length) * 100).toFixed(2)}%`,
          );

          // åˆ›å»ºé¢„è§ˆ
          const blob = new Blob([result], { type: "image/avif" });
          const url = URL.createObjectURL(blob);
          log(
            `   é¢„è§ˆï¼š<a href="${url}" target="_blank">ç‚¹å‡»æŸ¥çœ‹å‹ç¼©åçš„å›¾ç‰‡</a>`,
          );

          return result;
        } catch (error) {
          log(`âŒ AVIF å‹ç¼©å¤±è´¥ï¼š${error.message}`, "error");
          console.error("AVIF compression error:", error);
          throw error;
        }
      }

      // æ—¥å¿—å‡½æ•°
      function log(message, type = "info") {
        const logEl = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById("log").innerHTML =
          '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", initWasm);

      // æš´éœ²å‡½æ•°åˆ°å…¨å±€
      window.testPngCompression = testPngCompression;
      window.testAvifCompression = testAvifCompression;
      window.clearLog = clearLog;
    </script>
  </body>
</html>
