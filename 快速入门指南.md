# ğŸš€ å¿«é€Ÿå…¥é—¨æŒ‡å—

åœ¨ 5 åˆ†é’Ÿå†…å®Œæˆ Rust WASM å›¾ç‰‡å‹ç¼©æ¨¡å—çš„é›†æˆï¼Œæ€§èƒ½æå‡ **20-40%**ï¼

---

## ğŸ“‹ å‰ç½®è¦æ±‚

- âœ… **Node.js** v18+
- âœ… **Git**
- âœ… **Rust** (å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†)
- âœ… **wasm-pack** (å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†)

---

## ğŸ”§ 5 åˆ†é’Ÿå¿«é€Ÿé›†æˆ

### æ­¥éª¤ 1ï¼šå…‹éš†é¡¹ç›®

```bash
git clone https://github.com/fjqz177/pic-smaller.git
cd pic-smaller
```

### æ­¥éª¤ 2ï¼šä¸€é”®å®‰è£…ä¸æ„å»º

**Windows PowerShell**:

```powershell
# å®‰è£…é¡¹ç›®ä¾èµ–
npm install

# å®‰è£… Rust (å¦‚æœè¿˜æ²¡æœ‰)
# è®¿é—® https://rustup.rs/ ä¸‹è½½å¹¶å®‰è£…

# æ·»åŠ  WASM ç›®æ ‡
rustup target add wasm32-unknown-unknown

# å®‰è£… wasm-pack
cargo install wasm-pack

# æ„å»º WASM å¹¶é›†æˆåˆ°é¡¹ç›®
npm run wasm:full
```

**Linux/macOS**:

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
npm install

# å®‰è£… Rust (å¦‚æœè¿˜æ²¡æœ‰)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env

# æ·»åŠ  WASM ç›®æ ‡
rustup target add wasm32-unknown-unknown

# å®‰è£… wasm-pack
cargo install wasm-pack

# æ„å»º WASM å¹¶é›†æˆåˆ°é¡¹ç›®
npm run wasm:full
```

### æ­¥éª¤ 3ï¼šå¯åŠ¨æµ‹è¯•

```bash
npm run dev
```

è®¿é—® http://localhost:3000 æµ‹è¯•å‹ç¼©åŠŸèƒ½ã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ ¼å¼         | æ—§ WASM | æ–° Rust WASM | æå‡       |
| ------------ | ------- | ------------ | ---------- |
| PNG (1080p)  | ~2.0s   | **~1.2s**    | â¬†ï¸ **40%** |
| AVIF (1080p) | ~3.5s   | **~2.8s**    | â¬†ï¸ **20%** |

_æµ‹è¯•ç¯å¢ƒï¼š1920x1080 å›¾ç‰‡ï¼Œä¸­ç­‰è´¨é‡è®¾ç½®_

---

## ğŸ¯ å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                     | è¯´æ˜                   |
| ------------------------ | ---------------------- |
| `npm run dev`            | å¯åŠ¨å¼€å‘æœåŠ¡å™¨         |
| `npm run build`          | ç”Ÿäº§æ„å»º               |
| `npm run preview`        | é¢„è§ˆç”Ÿäº§æ„å»º           |
| `npm run test`           | è¿è¡Œæµ‹è¯•               |
| `npm run lint`           | ä»£ç æ£€æŸ¥               |
| `npm run format`         | ä»£ç æ ¼å¼åŒ–             |
| `npm run clean`          | æ¸…ç†æ„å»ºæ–‡ä»¶           |
| `npm run clean:all`      | æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…æ‹¬ WASMï¼‰  |
| `npm run wasm:build`     | ä»…æ„å»º WASM æ¨¡å—       |
| `npm run wasm:integrate` | é›†æˆ WASM åˆ°é¡¹ç›®       |
| `npm run wasm:full`      | ä¸€é”®å®Œæˆæ‰€æœ‰ WASM æ“ä½œ |

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] `public/wasm/` ç›®å½•åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š
  - `pic_compress_wasm_bg.wasm` - WASM äºŒè¿›åˆ¶æ–‡ä»¶
  - `pic_compress_wasm.js` - JavaScript èƒ¶æ°´ä»£ç 
  - `pic_compress_wasm.d.ts` - TypeScript ç±»å‹å®šä¹‰
- [ ] `src/engines/PicCompressWasm.ts` å­˜åœ¨ï¼ˆTypeScript åŒ…è£…å™¨ï¼‰
- [ ] `vite.config.ts` åŒ…å« COOP/COEP headers
- [ ] å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- [ ] å›¾ç‰‡å‹ç¼©åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
pic-smaller/
â”œâ”€â”€ pic-compress-wasm/          # Rust æºä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs              # WASM å…¥å£
â”‚   â”‚   â”œâ”€â”€ png.rs              # PNG å‹ç¼©
â”‚   â”‚   â””â”€â”€ avif.rs             # AVIF å‹ç¼©
â”‚   â”œâ”€â”€ Cargo.toml              # Rust é…ç½®
â”‚   â””â”€â”€ pkg/                    # ç¼–è¯‘è¾“å‡ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ public/
â”‚   â””â”€â”€ wasm/                   # WASM æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ engines/
â”‚   â”‚   â”œâ”€â”€ PicCompressWasm.ts  # TypeScript åŒ…è£…å™¨
â”‚   â”‚   â”œâ”€â”€ PngImage.ts         # PNG å›¾åƒå¤„ç†
â”‚   â”‚   â””â”€â”€ AvifImage.ts        # AVIF å›¾åƒå¤„ç†
â”‚   â””â”€â”€ ...
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build-wasm.cjs          # WASM æ„å»ºè„šæœ¬
â”‚   â””â”€â”€ integrate-wasm.cjs      # WASM é›†æˆè„šæœ¬
â””â”€â”€ package.json
```

---

## ğŸ” æ•…éšœæ’é™¤

### wasm-pack æœªå®‰è£…

**é”™è¯¯**: `wasm-pack not found`

**è§£å†³**:

```bash
cargo install wasm-pack
```

æˆ–è€…ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬ï¼š

```bash
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
```

### Rust æœªå®‰è£…

**é”™è¯¯**: `cargo: command not found`

**è§£å†³**:

**Windows**: è®¿é—® https://rustup.rs/ ä¸‹è½½å®‰è£…

**Linux/macOS**:

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

### WASM åŠ è½½å¤±è´¥

**é”™è¯¯**: `WebAssembly.instantiate() failed`

**è§£å†³**:

1. æ£€æŸ¥ `vite.config.ts` ä¸­çš„ headers é…ç½®ï¼š
   ```typescript
   server: {
     headers: {
       "Cross-Origin-Opener-Policy": "same-origin",
       "Cross-Origin-Embedder-Policy": "require-corp",
     },
   }
   ```
2. ç¡®ä¿ `public/wasm/` ç›®å½•å­˜åœ¨ä¸”åŒ…å« WASM æ–‡ä»¶
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°

### æ„å»ºå¤±è´¥

**é”™è¯¯**: WASM æ„å»ºè¿‡ç¨‹ä¸­å‡ºé”™

**è§£å†³**:

```bash
# æ¸…ç† WASM æ„å»ºæ–‡ä»¶
cd pic-compress-wasm
rm -rf pkg target
cd ..

# é‡æ–°æ„å»º
npm run wasm:full
```

### ç±»å‹é”™è¯¯

**é”™è¯¯**: TypeScript ç±»å‹ä¸åŒ¹é…

**è§£å†³**:

```bash
# é‡æ–°ç”Ÿæˆç±»å‹å®šä¹‰
npm run wasm:build
```

---

## ğŸ’¡ å¼€å‘æç¤º

### å¼€å‘æ¨¡å¼æ„å»º

å¼€å‘æ¨¡å¼ä¸‹æ„å»ºæ›´å¿«ï¼ˆä½†æ–‡ä»¶æ›´å¤§ï¼‰ï¼š

```bash
cd pic-compress-wasm
wasm-pack build --dev --target web --out-dir ../public/wasm
```

### ç”Ÿäº§æ„å»ºä¼˜åŒ–

ç”Ÿäº§æ„å»ºå·²å¯ç”¨ä»¥ä¸‹ä¼˜åŒ–ï¼š

- **LTO (Link-Time Optimization)**: å®Œæ•´é“¾æ¥æ—¶ä¼˜åŒ–
- **opt-level 3**: æœ€é«˜ä¼˜åŒ–çº§åˆ«
- **strip**: ç§»é™¤è°ƒè¯•ä¿¡æ¯
- **wasm-opt -O4**: WASM äºŒè¿›åˆ¶ä¼˜åŒ–

### å¯ç”¨ SIMD åŠ é€Ÿ

åœ¨ `pic-compress-wasm/Cargo.toml` ä¸­æ·»åŠ ï¼š

```toml
[profile.release]
target-cpu = "simd128"  # å¯ç”¨ WASM SIMD
```

ç„¶åé‡æ–°æ„å»ºï¼š

```bash
npm run wasm:build
```

---

## ğŸ“– æ›´å¤šæ–‡æ¡£

- [`README.md`](./README.md) - é¡¹ç›®æ€»è§ˆ
- [`docs/log_doc/WASM_INTEGRATION.md`](./docs/log_doc/WASM_INTEGRATION.md) - è¯¦ç»†é›†æˆæ–‡æ¡£
- [`pic-compress-wasm/README.md`](./pic-compress-wasm/README.md) - WASM æ¨¡å— API æ–‡æ¡£

---

**é›†æˆå®Œæˆï¼** ğŸ‰
